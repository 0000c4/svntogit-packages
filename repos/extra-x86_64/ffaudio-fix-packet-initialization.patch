From 634cca030d4b9c03f86ed0a2c95f64b1c8b4eb80 Mon Sep 17 00:00:00 2001
From: John Lindgren <john.lindgren@aol.com>
Date: Thu, 22 Dec 2016 15:26:31 -0500
Subject: [PATCH] ffaudio: av_init_packet() is not enough to initialize the
 packet.  Closes: #691.

---
 src/ffaudio/ffaudio-core.cc | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/src/ffaudio/ffaudio-core.cc b/src/ffaudio/ffaudio-core.cc
index 4800db1..390160c 100644
--- a/src/ffaudio/ffaudio-core.cc
+++ b/src/ffaudio/ffaudio-core.cc
@@ -99,7 +99,8 @@ struct ScopedContext
 
 struct ScopedPacket : public AVPacket
 {
-    ScopedPacket () { av_init_packet (this); }
+    ScopedPacket () : AVPacket ()
+        { av_init_packet (this); }
 
 #if CHECK_LIBAVCODEC_VERSION (55, 25, 100, 55, 16, 0)
     ~ScopedPacket () { av_packet_unref (this); }
@@ -553,8 +554,10 @@ bool FFaudio::play (const char * filename, VFSFile & file)
         /* On EOF, send an empty packet to "flush" the decoder */
         /* Otherwise, make a mutable (shallow) copy of the real packet */
         AVPacket tmp;
-        if (eof)
+        if (eof) {
+            tmp = AVPacket ();
             av_init_packet (& tmp);
+        }
         else
             tmp = pkt;
 
