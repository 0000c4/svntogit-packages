# $Id$
# Maintainer: Andreas Radke <andyrtr@archlinux.org>
# Contributor: amdviaman

pkgname=catalyst
pkgver=8.12
_kernel_version=2.6.28
pkgrel=2
pkgdesc="Proprietary AMD/ATI kernel drivers for Radeon brand cards. Stock kernel."
arch=('i686' 'x86_64')
url="http://www.ati.amd.com"
license=('custom') 
depends=("catalyst-utils>=${pkgver}" "kernel26>=2.6.28" "kernel26<2.6.29")
makedepends=()
replaces=('ati-fglrx' 'fglrx') # Yay rebranding
install=catalyst.install
source=(#http://archive.ubuntu.com/ubuntu/pool/multiverse/f/fglrx-installer/fglrx-installer_8.543.orig.tar.gz
	#ftp://ftp.archlinux.org/other/catalyst/fglrx-installer_8.543.orig.tar.gz
	#XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX-x86.x86_64.run
	http://www2.ati.com/drivers/linux/ati-driver-installer-${pkgver/./-}-x86.x86_64.run)
_kernver=${_kernel_version}-ARCH
md5sums=('2a62d8c5173f091379e458371782a580')

build() {
  /bin/sh ./ati-driver-installer-${pkgver/./-}-x86.x86_64.run --extract archive_files
#  /bin/sh ./ati-driver-installer-XXXXXXXX-x86.x86_64.run --extract archive_files

  if [ "${CARCH}" = "x86_64" ]; then
    BUILDARCH=x86_64
    _archdir=x86_64
  fi
  if [ "${CARCH}" = "i686" ]; then
    BUILDARCH=i386
    _archdir=x86
  fi

#  cd "${srcdir}/lib/modules/fglrx/build_mod"
  cd "${srcdir}/archive_files/common/lib/modules/fglrx/build_mod"
#  cp "${srcdir}/arch/${_archdir}/lib/modules/fglrx/build_mod/libfglrx_ip.a.GCC4" . || return 1
  cp "${srcdir}/archive_files/arch/${_archdir}/lib/modules/fglrx/build_mod/libfglrx_ip.a.GCC4" . || return 1

  cp 2.6.x/Makefile . || return 1
  make -C /lib/modules/${_kernver}/build SUBDIRS="`pwd`" ARCH=${BUILDARCH} modules || return 1

  install -m755 -d "${pkgdir}/lib/modules/${_kernver}/video/"
  install -m644 fglrx.ko "${pkgdir}/lib/modules/${_kernver}/video/" || return 1

  install -m755 -d "${pkgdir}/usr/share/licenses/${pkgname}"
#  install -m644 "${srcdir}/usr/share/doc/fglrx/ATI_LICENSE.TXT" "${pkgdir}/usr/share/licenses/${pkgname}/" || return 1
  install -m644 "${srcdir}/archive_files/ATI_LICENSE.TXT" "${pkgdir}/usr/share/licenses/${pkgname}/" || return 1
}
