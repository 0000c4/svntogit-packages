# $Id$
# Maintainer: Ronald van Haren <ronald.archlinux.org>
# Contributor: dongiovanni <dongiovanni.archlinux.de>

pkgname=grub2
pkgver=1.96_20081229
pkgrel=1
pkgdesc="The GNU GRand Unified Bootloader"
url="http://www.gnu.org/software/grub/"
arch=('i686' 'x86_64')
license=('GPL3')

depends=('bash' 'lzo2')
conflicts=('grub')
provides=('grub')
backup=('boot/grub/grub.cfg')
install=${pkgname}.install

source=(http://www.archlinux.org/~ronald/grub2-1.96_20081229.tar.bz2
	# use our own svn checkout so disable snapshot
	#ftp://alpha.gnu.org/gnu/grub/grub-${pkgver}.tar.gz  
	'grub.cfg'  
	'install-grub')  
md5sums=('e677ad5d3048c48c614bf703a74e4599'
         '743215998a581a54ac77630f0db222ce'
         '3182c4ae4963a16930bc772bba89dacf')

build() {
  # Set destination architecture here
  #DESTARCH="i686"
  DESTARCH="x86_64"

  cd $srcdir/${pkgname}-${pkgver}

  # Arch64 grub2 needs to be statically build on i686
  if [ "$CARCH" = "x86_64" ]; then
    echo "this package has to be built on i686, won't compile on x86_64"
    sleep 5
  else

    if [ "$DESTARCH" = "x86_64" ]; then
	export LDFLAGS=-static
        export CFLAGS=-static
	./configure --prefix=/usr --bindir=/bin --sbindir=/sbin \
                        --mandir=/usr/share/man --infodir=/usr/share/info \
			--sysconfdir=/etc
	unset CFLAGS CPPFLAGS LDFLAGS

    else
      CFLAGS= ./configure --prefix=/usr --bindir=/bin --sbindir=/sbin \
                --mandir=/usr/share/man --infodir=/usr/share/info \
		--sysconfdir=/etc
    fi
  fi

  CFLAGS= make || return 1
  make DESTDIR=${pkgdir} install || return 1
  
  install -Dm644 ${srcdir}/grub.cfg $startdir/pkg/boot/grub/grub.cfg
  install -Dm755 ${srcdir}/install-grub $startdir/pkg/sbin/install-grub

  # Fool makepkg into building a x86_64 package
  if [ "$DESTARCH" = "x86_64" ]; then
    export CARCH="x86_64"
  fi
}
