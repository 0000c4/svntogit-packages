# $Id$
# Maintainer: Ronald van Haren <ronald.archlinux.org>
# Contributor: dongiovanni <dongiovanni.archlinux.de>

pkgname=grub2
pkgver=1.96
pkgrel=1
pkgdesc="The GNU GRand Unified Bootloader"
url="http://www.gnu.org/software/grub/"
arch=('i686' 'x86_64')
license=('GPL3')
depends=()
conflicts=('grub')
provides=('grub')
backup=('boot/grub/grub.cfg')
install=${pkgname}.install
source=(ftp://alpha.gnu.org/gnu/grub/grub-${pkgver}.tar.gz 'grub.cfg' 'install-grub' 
	'grub-1.96-chainloader.patch')
md5sums=('0a40cd2326a4e84d1978060f2e02a956'
         '743215998a581a54ac77630f0db222ce'
         '3182c4ae4963a16930bc772bba89dacf'
         '83cc4ebc0d41caa67a9954bd2ae3af15')

build() {
  # Set destination architecture here
  DESTARCH="i686"
  #DESTARCH="x86_64"

  cd $srcdir/grub-${pkgver}

  # Fix chainloader issue
  patch -Np1 -i $srcdir/grub-1.96-chainloader.patch || return 1  

  # Arch64 grub2 needs to be statically build on i686
  if [ "$CARCH" = "x86_64" ]; then
    echo "this package has to be built on i686, won't compile on x86_64"
    sleep 5
  else

    if [ "$DESTARCH" = "x86_64" ]; then
	export LDFLAGS=-static
        export CFLAGS=-static
	./configure --prefix=/usr --bindir=/bin --sbindir=/sbin \
                        --mandir=/usr/share/man --infodir=/usr/share/info \
			--sysconfdir=/etc
	unset CFLAGS CPPFLAGS LDFLAGS

    else
      CFLAGS= ./configure --prefix=/usr --bindir=/bin --sbindir=/sbin \
                --mandir=/usr/share/man --infodir=/usr/share/info \
		--sysconfdir=/etc
    fi
  fi

  CFLAGS= make || return 1
  make DESTDIR=${pkgdir} install || return 1
  
  install -Dm644 ${srcdir}/grub.cfg $startdir/pkg/boot/grub/grub.cfg
  install -Dm755 ${srcdir}/install-grub $startdir/pkg/sbin/install-grub

  # Fool makepkg into building a x86_64 package
  if [ "$DESTARCH" = "x86_64" ]; then
    export CARCH="x86_64"
  fi
}
