# $Id$
# Maintainer: Aaron Griffin <aaron@archlinux.org>
# Maintainer: Thomas Baechler <thomas@archlinux.org>

###
### NOTE: Do not build this package with anything except gcc - using ccache
###  forces others to use it as well as it becomes hardcoded in the klibc
###  script.
###

pkgname=klibc
pkgver=1.5.14
_klibcbranch=Testing #Stable/Testing
_kver=2.6.26-ARCH
pkgrel=1
pkgdesc="A minimal libc made for early-userspace"
arch=(i686 x86_64)
url="http://www.kernel.org/pub/linux/libs/klibc/"
license=('BSD')
groups=('base')
options=(!ccache !strip)
source=(http://www.kernel.org/pub/linux/libs/klibc/${_klibcbranch}/${pkgname}-${pkgver}.tar.gz
        klibc-compile-shared-by-default.patch
        klibc-Kbuild.patch
        klibc-x86_64-fix-io.h.patch)
md5sums=('8c65712a24c4bde5ec9870f5a4f8113e'
         'c263a7c3fd290fcc84a4e230d456d022'
         'ff5b113024256de31af59c2f1a966516'
         'fcee75cfaa65638b07f9cc4a7719fa29')
                  
build()
{
  cd $startdir/src/$pkgname-$pkgver
  #INI_DEBUG causes ipconfig to fail within kinit
  sed -i "/#define INI_DEBUG/d" usr/kinit/kinit.h || return 1
  ln -sf /usr/src/linux-${_kver} linux

  # compile binaries shared by default
  patch -p1 -i ../klibc-compile-shared-by-default.patch || return 1
  # don't build gzip, cpio, kill, build shared binaries for kinit and sh
  patch -p1 -i ../klibc-Kbuild.patch || return 1
  # fix errors in io.h header
  patch -p1 -i ../klibc-x86_64-fix-io.h.patch || return 1
  
  make EXTRA_KLIBCFLAGS='' || return 1
  make INSTALLROOT=$startdir/pkg install || return 1
  ln -sf asm-x86 $startdir/pkg/usr/lib/klibc/include/asm
  
  provides[${#provides[@]}]="$(basename $startdir/pkg/lib/klibc-*.so .so)"
  export provides
}
