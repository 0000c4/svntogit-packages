# $Id$
# Maintainer: Felix Yan <felixonmars@archlinux.org>
# Maintainer: Antonio Rojas <arojas@archlinux.org>
# Contributor: Andrea Scarpino <andrea@archlinux.org>

pkgbase=plasma-desktop
pkgname=(plasma-desktop knetattach)
pkgver=5.10.2
pkgrel=2
pkgdesc='KDE Plasma Desktop'
arch=('i686' 'x86_64')
url='https://www.kde.org/workspaces/plasmadesktop/'
license=('LGPL')
source=("https://download.kde.org/stable/plasma/$pkgver/$pkgname-$pkgver.tar.xz"{,.sig}
        kdebug-381129.patch::"https://cgit.kde.org/plasma-desktop.git/patch/?id=84300b51")
depends=('polkit-kde-agent' 'libcanberra' 'libxkbfile' 'kmenuedit' 'appstream-qt'
         'systemsettings' 'ksysguard' 'kpeople' 'baloo' 'qt5-graphicaleffects' 'kactivities-stats')
makedepends=('extra-cmake-modules' 'kdoctools' 'boost' 'xf86-input-evdev' 'xf86-input-synaptics' 'xorg-server-devel'
             'libibus' 'scim' 'python' 'kdesignerplugin')
groups=('plasma')
sha256sums=('3677afa111e0d37fa1f222bc3c397b6b1998d34e4f0c72f6883b5469ac285fd6'
            'SKIP'
            '61346b641504dba4004e384f903acdc90b179728277c72b4e60343a56202a93a')
validpgpkeys=('2D1D5B0588357787DE9EE225EC94D18F7F05997E'  # Jonathan Riddell
              '348C8651206633FD983A8FC4DEACEA00075E1D76'  # KDE Neon
              'D07BD8662C56CB291B316EB2F5675605C74E02CF') # David Edmundson

prepare() {
  mkdir -p build

# Fix drag and drop onto grouped tasks https://bugs.kde.org/show_bug.cgi?id=381129
  cd $pkgname-$pkgver
  patch -p1 -i ../kdebug-381129.patch
}

build() {
  cd build
  cmake ../$pkgname-$pkgver \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DKDE_INSTALL_LIBDIR=lib \
    -DKDE_INSTALL_LIBEXECDIR=lib \
    -DBUILD_TESTING=OFF
  make
}

package_plasma-desktop() {
  depends+=(knetattach)
  optdepends=('plasma-nm: Network manager applet'
            'powerdevil: power management'
            'ibus: kimpanel IBUS support'
            'scim: kimpanel SCIM support'
            'discover: manage applications installation from the launcher')
  conflicts=('kdebase-workspace' 'kcm-touchpad-frameworks' 'kdeplasma-addons<5.5.95' 'kactivities<5.19.0-3')
  replaces=('kcm-touchpad-frameworks')

  cd build
  make DESTDIR="$pkgdir" install

# Split knetattach
  rm "$pkgdir"/usr/{bin/knetattach,share/applications/org.kde.knetattach.desktop}
}

package_knetattach() {
  pkgdesc='Wizard which makes it easier to integrate network resources with the Plasma Desktop'
  depends=(kdelibs4support)

  cd build/knetattach
  make DESTDIR="$pkgdir" install
}
