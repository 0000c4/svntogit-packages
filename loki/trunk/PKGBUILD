# Maintainer: Jelle van der Waa <jelle@archlinux.org>

pkgname=loki
pkgver=1.3.0
pkgrel=1
pkgdesc='like Prometheus, but for logs'
url='https://github.com/grafana/loki'
arch=('x86_64')
license=('Apache')
depends=('glibc')
makedepends=('go-pie')
backup=('etc/loki/loki.yaml' 'etc/loki/promtail.yaml')
source=($pkgname-$pkgver.tar.gz::https://github.com/grafana/loki/archive/v$pkgver.tar.gz)
sha512sums=('db2c5e81b2b24d884f2c56531e577beae693cc06e30fe74b4d89b6b1c3857992396aeb46877ab5b787b268741cc9de75fd5ed53c548de6abac701afe97477df2')

build() {
  cd loki-$pkgver

  LDFLAGS="-extldflags $LDFLAGS"

  go build \
    -trimpath \
    -ldflags "$LDFLAGS" \
    ./cmd/loki

  go build \
    -trimpath \
    -ldflags "$LDFLAGS" \
    ./cmd/promtail
}

check() {
  cd loki-$pkgver

  go test -v $(go list  ./... | grep -v "distributor")
}

package() {
  cd loki-$pkgver

  install -Dm755 -t "$pkgdir"/usr/bin loki promtail

  install -Dm644 cmd/promtail/promtail-local-config.yaml $pkgdir/etc/loki/promtail.yaml
  install -Dm644 cmd/loki/loki-local-config.yaml $pkgdir/etc/loki/loki.yaml
}
